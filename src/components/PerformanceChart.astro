---
// Performance Chart - Datos reales de rendimiento
// Datos medidos en Dufour 31 con batería 12.1-12.8V
---

<section id="rendimiento" class="py-20 lg:py-28 px-4 relative overflow-hidden">
  <!-- Video de fondo -->
  <video
    autoplay
    muted
    loop
    playsinline
    class="absolute inset-0 w-full h-full object-cover"
  >
    <source src="/video/hydro-action.mp4" type="video/mp4" />
  </video>
  
  <!-- Overlay oscuro para legibilidad -->
  <div class="absolute inset-0 bg-dark/85 backdrop-blur-[2px]"></div>
  
  <!-- Glows decorativos -->
  <div class="absolute top-1/2 left-1/4 -translate-y-1/2 w-[400px] h-[400px] bg-cyan/8 rounded-full blur-[100px] pointer-events-none"></div>
  <div class="absolute top-1/3 right-1/4 w-[300px] h-[300px] bg-blue/8 rounded-full blur-[80px] pointer-events-none"></div>

  <div class="max-w-6xl mx-auto w-full relative z-10">
    
    <!-- Header -->
    <div class="text-center mb-12 animate-on-scroll">
      <span class="text-cyan text-sm font-semibold tracking-wider uppercase mb-4 block">
        Rendimiento real
      </span>
      <h2 class="font-serif text-4xl sm:text-5xl lg:text-6xl mb-6">
        Datos medidos en navegación
      </h2>
      <p class="text-xl text-gray-400 max-w-2xl mx-auto">
        Prueba real en un Dufour 31 con sistema de 12V
      </p>
    </div>

    <!-- Chart Container -->
    <div class="bg-gray-900/50 rounded-3xl p-6 lg:p-10 border border-cyan/20 animate-on-scroll backdrop-blur-sm">
      
      <!-- Chart Title -->
      <div class="text-center mb-8">
        <h3 class="text-xl lg:text-2xl font-semibold mb-2">
          SWI-TEC Hydro Charger Universal
        </h3>
        <p class="text-gray-400">
          Sailboat Dufour 31 — Battery 12.1–12.8V
        </p>
      </div>

      <!-- Canvas del gráfico -->
      <div class="relative w-full" style="height: 400px;">
        <canvas id="performanceChart"></canvas>
      </div>

      <!-- Leyenda custom -->
      <div class="flex flex-wrap justify-center gap-6 mt-6 text-sm">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-cyan"></span>
          <span class="text-gray-300">Amperios medidos</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-8 h-0.5 bg-blue rounded"></span>
          <span class="text-gray-300">Línea de tendencia</span>
        </div>
      </div>
    </div>

    <!-- Stats destacados -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mt-10 animate-on-scroll">
      <div class="bg-gray-900/30 border border-cyan/10 rounded-xl p-5 text-center backdrop-blur-sm">
        <div class="text-3xl lg:text-4xl font-bold text-cyan mb-1">12A</div>
        <div class="text-sm text-gray-400">Máximo a 7 nudos</div>
      </div>
      <div class="bg-gray-900/30 border border-cyan/10 rounded-xl p-5 text-center backdrop-blur-sm">
        <div class="text-3xl lg:text-4xl font-bold text-cyan mb-1">300W</div>
        <div class="text-sm text-gray-400">Potencia pico</div>
      </div>
      <div class="bg-gray-900/30 border border-cyan/10 rounded-xl p-5 text-center backdrop-blur-sm">
        <div class="text-3xl lg:text-4xl font-bold text-cyan mb-1">3 kn</div>
        <div class="text-sm text-gray-400">Velocidad mínima</div>
      </div>
      <div class="bg-gray-900/30 border border-cyan/10 rounded-xl p-5 text-center backdrop-blur-sm">
        <div class="text-3xl lg:text-4xl font-bold text-cyan mb-1">12V</div>
        <div class="text-sm text-gray-400">Sistema probado</div>
      </div>
    </div>


  </div>
</section>

<!-- Chart.js desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // Datos reales medidos
  const rawData = [
    { knots: 2.0, amps: 1.5 },
    { knots: 3.0, amps: 3.5 },
    { knots: 4.0, amps: 5.0 },
    { knots: 4.3, amps: 6.8 },
    { knots: 4.4, amps: 7.0 },
    { knots: 4.5, amps: 5.5 },
    { knots: 4.6, amps: 8.0 },
    { knots: 4.8, amps: 7.9 },
    { knots: 5.0, amps: 6.0 },
    { knots: 5.0, amps: 7.0 },
    { knots: 5.2, amps: 8.4 },
    { knots: 5.4, amps: 8.5 },
    { knots: 6.0, amps: 9.0 },
    { knots: 7.0, amps: 12.0 },
  ];

  // Calcular línea de tendencia (regresión polinomial grado 2)
  function polyfit(x: number[], y: number[], degree: number): number[] {
    const n = x.length;
    const matrix: number[][] = [];
    const vector: number[] = [];
    
    for (let i = 0; i <= degree; i++) {
      matrix[i] = [];
      for (let j = 0; j <= degree; j++) {
        let sum = 0;
        for (let k = 0; k < n; k++) {
          sum += Math.pow(x[k], i + j);
        }
        matrix[i][j] = sum;
      }
      let sum = 0;
      for (let k = 0; k < n; k++) {
        sum += y[k] * Math.pow(x[k], i);
      }
      vector[i] = sum;
    }
    
    // Resolver sistema (Gauss-Jordan simplificado)
    for (let i = 0; i <= degree; i++) {
      let maxRow = i;
      for (let k = i + 1; k <= degree; k++) {
        if (Math.abs(matrix[k][i]) > Math.abs(matrix[maxRow][i])) {
          maxRow = k;
        }
      }
      [matrix[i], matrix[maxRow]] = [matrix[maxRow], matrix[i]];
      [vector[i], vector[maxRow]] = [vector[maxRow], vector[i]];
      
      for (let k = i + 1; k <= degree; k++) {
        const c = matrix[k][i] / matrix[i][i];
        for (let j = i; j <= degree; j++) {
          matrix[k][j] -= c * matrix[i][j];
        }
        vector[k] -= c * vector[i];
      }
    }
    
    const coeffs: number[] = new Array(degree + 1);
    for (let i = degree; i >= 0; i--) {
      coeffs[i] = vector[i];
      for (let j = i + 1; j <= degree; j++) {
        coeffs[i] -= matrix[i][j] * coeffs[j];
      }
      coeffs[i] /= matrix[i][i];
    }
    
    return coeffs;
  }

  function evalPoly(coeffs: number[], x: number): number {
    let result = 0;
    for (let i = 0; i < coeffs.length; i++) {
      result += coeffs[i] * Math.pow(x, i);
    }
    return result;
  }

  // Preparar datos
  const xData = rawData.map(d => d.knots);
  const yData = rawData.map(d => d.amps);
  
  // Calcular coeficientes de tendencia (grado 2)
  const coeffs = polyfit(xData, yData, 2);
  
  // Generar puntos para la línea de tendencia
  const trendX: number[] = [];
  const trendY: number[] = [];
  for (let x = 2; x <= 8; x += 0.1) {
    trendX.push(x);
    trendY.push(Math.max(0, evalPoly(coeffs, x)));
  }

  // Crear gráfico
  document.addEventListener('DOMContentLoaded', () => {
    const ctx = document.getElementById('performanceChart') as HTMLCanvasElement;
    
    if (ctx && typeof Chart !== 'undefined') {
      new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Amperios medidos',
              data: rawData.map(d => ({ x: d.knots, y: d.amps })),
              backgroundColor: '#00d4ff',
              borderColor: '#00d4ff',
              pointRadius: 8,
              pointHoverRadius: 10,
              pointStyle: 'circle',
            },
            {
              label: 'Línea de tendencia',
              data: trendX.map((x, i) => ({ x, y: trendY[i] })),
              type: 'line',
              borderColor: '#3b82f6',
              borderWidth: 3,
              pointRadius: 0,
              tension: 0.4,
              fill: false,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#1a2332',
              titleColor: '#fff',
              bodyColor: '#9ca3af',
              borderColor: '#00d4ff',
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                title: (items) => {
                  if (items.length > 0) {
                    return `${items[0].parsed.x.toFixed(1)} nudos`;
                  }
                  return '';
                },
                label: (item) => {
                  const amps = item.parsed.y.toFixed(1);
                  const watts = (item.parsed.y * 25).toFixed(0);
                  return [`${amps} A`, `≈ ${watts} W`];
                }
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              min: 1.5,
              max: 8,
              title: {
                display: true,
                text: 'Velocidad (nudos)',
                color: '#9ca3af',
                font: { size: 14, weight: '500' }
              },
              grid: {
                color: 'rgba(255,255,255,0.05)',
              },
              ticks: {
                color: '#9ca3af',
                stepSize: 1
              }
            },
            y: {
              type: 'linear',
              min: 0,
              max: 15,
              position: 'left',
              title: {
                display: true,
                text: 'Corriente (A)',
                color: '#9ca3af',
                font: { size: 14, weight: '500' }
              },
              grid: {
                color: 'rgba(255,255,255,0.05)',
              },
              ticks: {
                color: '#9ca3af',
              }
            }
          }
        }
      });
    }
  });
</script>

<style>
  #performanceChart {
    max-width: 100%;
  }
</style>

